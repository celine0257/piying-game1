<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è…¾å†²çš®å½±æˆ Â· éé—æ¢ç§˜é—¯å…³</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--ok:#34d399;--warn:#f59e0b}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei";background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
h1,h2{margin:0 0 12px}
.muted{color:var(--muted);font-size:14px}
input,select,button{border-radius:12px;border:1px solid #1f2937;padding:10px 12px;background:#0b1220;color:#fff}
button{background:var(--brand);color:#09111f;font-weight:700;cursor:pointer;border:none}
button.ghost{background:#0b1220;color:#fff;border:1px solid #374151}
button:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:12px;background:#0b1220;border:1px solid #374151;padding:2px 10px;border-radius:999px;color:#cbd5e1}
.progress{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.dot{width:10px;height:10px;border-radius:50%;background:#1f2937}
.dot.on{background:linear-gradient(180deg,#a7f3d0,#10b981)}
.gallery{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.gallery img{width:100%;height:240px;object-fit:cover;border-radius:12px;border:1px solid #374151}
.gallery .span2{grid-column:1/span 2;height:280px}
.cap{font-size:12px;color:#cbd5e1;margin:6px 2px 0}
.timeline{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px}
.stepSlot{min-height:72px;display:flex;align-items:center;justify-content:center;border:2px dashed #374151;border-radius:12px;color:#94a3b8;background:#0b1220}
.stepSlot.locked{opacity:.6;filter:grayscale(30%)}
.stepSlot.active{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3) inset}
.part{user-select:none;margin:8px 0;padding:10px 12px;background:#0f172a;border:1px solid #1f2937;border-radius:12px;cursor:grab}
.partsBox{background:#0b1220;border:1px solid #374151;border-radius:16px;padding:12px}
.good{outline:2px solid var(--ok)}
.warn{outline:2px solid var(--warn)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.info{background:#0b1220;border:1px solid #374151;border-radius:14px;padding:12px;cursor:pointer}
.info .title{font-weight:700;margin-bottom:6px}
.info .content{display:none;font-size:13px;color:#cbd5e1}
.info.learned{outline:2px solid var(--ok)}
.board{--cols:4;display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:10px}
.cardtile{height:90px;background:#0b1220;border:1px solid #374151;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700}
.cardtile.open{background:linear-gradient(135deg,#0b1220,#0f172a)}
.videoWrap{background:#0b1220;border:1px solid #374151;border-radius:16px;padding:12px}
video{width:100%;border-radius:12px;background:#000}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
th,td{border-bottom:1px solid #223;padding:8px;text-align:left}
.footer{font-size:12px;color:#9ca3af;text-align:center;margin-top:8px}
@keyframes shakeX{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-6px)}40%,60%{transform:translateX(6px)}}
.shake{animation:shakeX .35s ease}
@media (max-width:900px){.board{--cols:3}}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>è…¾å†²çš®å½±æˆ Â· éé—æ¢ç§˜é—¯å…³</h1>
    <p class="muted">â‘ åˆ¶ä½œæ­¥éª¤ â†’ â‘¡è¯æ¡å­¦ä¹ ï¼ˆ10æ¡ï¼‰ â†’ â‘¢è®°å¿†é…å¯¹ï¼ˆéšæœº 6 æ¡ï¼Œ12 å¼ å¡ï¼‰ â†’ â‘£å¥–åŠ±è§†é¢‘ã€‚é€šå…³åè‡ªåŠ¨ä¸ŠæŠ¥äº‘ç«¯ï¼ˆé£ä¹¦ï¼‰ã€‚</p>
    <div class="progress">
      <label>æ˜µç§° <input id="name" placeholder="å¦‚ï¼šå…­ï¼ˆ3ï¼‰-29"></label>
      <label>å¹´çº§
        <select id="grade"><option value="">è¯·é€‰æ‹©</option><option>ä¸€å¹´çº§</option><option>äºŒå¹´çº§</option><option>ä¸‰å¹´çº§</option><option>å››å¹´çº§</option><option>äº”å¹´çº§</option><option>å…­å¹´çº§</option></select>
      </label>
      <label>ç­çº§ <input id="klass" placeholder="å¦‚ï¼šå…­ï¼ˆ3ï¼‰ç­"></label>
      <label>åŒæ„åŒ¿åæ•°æ®
        <select id="consent"><option>æ˜¯</option><option>å¦</option></select>
      </label>
      <span class="badge">ç”¨æ—¶ï¼š<span id="time">0</span>s</span>
      <span class="badge">è¿›åº¦</span><span class="dot" id="d1"></span><span class="dot" id="d2"></span><span class="dot" id="d3"></span><span class="dot" id="d4"></span>
      <button id="start">å¼€å§‹</button>
      <button id="reset" class="ghost" disabled>é‡æ¥</button>
      <button id="export" class="ghost">å¯¼å‡ºå…¨éƒ¨CSV</button>
    </div>
  </div>

  <!-- å¼€åœºå±•æ¿ -->
  <div class="card" id="panel-intro">
    <h2>å¼€åœºå±•æ¿</h2>
    <div class="gallery">
      <div class="span2"><img src="æ ¡å¾½.png" alt=""><div class="cap">äº‘å—å¸ˆå¤§é™„å°ï¼šéé—è¿›æ ¡å›­ï¼Œçš®å½±æˆâ€œçœ‹å¾—è§ã€ç©å¾—èµ·ã€è¯´å¾—å‡ºâ€ã€‚</div></div>
      <div><img src="çš®å½±_æ ‘ä¸‹å¯¹å.jpg" alt=""><div class="cap">å½±çª—ï¼ˆç™½å¹•ï¼‰+èƒŒåç¯å…‰ï¼Œæ¼”å‘˜åœ¨å¹•åæ“æ†ï¼Œè§‚ä¼—åœ¨å¹•å‰çœ‹â€œå½±â€ã€‚</div></div>
      <div><img src="çš®å½±_å­¦ç”Ÿè‡ªåˆ¶.jpg" alt=""><div class="cap">é å­å¯ç”¨å¡çº¸/PPç‰‡ç†è§£ç»“æ„ä¸è¿æ¥æ–¹æ³•ã€‚</div></div>
      <div><img src="çš®å½±_å­¦ç”Ÿè¡¨æ¼”.jpg" alt=""><div class="cap">ç»†ç«¹æ†è”åŠ¨å…³èŠ‚ï¼›é”£é¼“å”¢å‘é…åˆèŠ‚å¥ã€‚</div></div>
    </div>
  </div>

  <!-- ç¬¬ä¸€å…³ï¼šé¡ºåºæ‹¼å›¾ï¼ˆå®Œæ•´é€»è¾‘ä¿ç•™ï¼‰ -->
  <div class="card" id="panel-l1" style="display:none">
    <h2>ç¬¬ä¸€å…³ Â· åˆ¶ä½œæ­¥éª¤ï¼ˆé¡ºåºæ‹¼å›¾ï¼‰</h2>
    <p class="muted">æŠŠ<strong>ä¸‹ä¸€æ­¥</strong>æ‹–å…¥å¯¹åº”æ§½ä½ï¼ˆåªèƒ½æ”¾å¯¹å½“å‰è¿™ä¸€æ­¥ï¼‰ã€‚</p>
    <div class="timeline" id="slots">
      <div class="stepSlot" data-index="0">ç¬¬1æ­¥</div>
      <div class="stepSlot locked" data-index="1">ç¬¬2æ­¥</div>
      <div class="stepSlot locked" data-index="2">ç¬¬3æ­¥</div>
      <div class="stepSlot locked" data-index="3">ç¬¬4æ­¥</div>
      <div class="stepSlot locked" data-index="4">ç¬¬5æ­¥</div>
      <div class="stepSlot locked" data-index="5">ç¬¬6æ­¥</div>
    </div>
    <div class="partsBox" id="parts"></div>
    <div style="margin-top:8px"><button id="to-l2" class="ghost" disabled>è¿›å…¥ç¬¬äºŒå…³ âœ</button></div>
  </div>

  <!-- ç¬¬äºŒå…³ï¼šè¯æ¡ -->
  <div class="card" id="panel-l2" style="display:none">
    <h2>ç¬¬äºŒå…³ Â· çŸ¥è¯†è¯æ¡ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</h2>
    <p class="muted">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹å°çŸ¥è¯†ï¼Œå…¨éƒ¨ç‚¹äº®åè¿›å…¥ç¬¬ä¸‰å…³ã€‚</p>
    <div class="grid" id="infogrid"></div>
    <div style="margin-top:8px"><button id="to-l3" class="ghost" disabled>å¼€å§‹ç¬¬ä¸‰å…³ âœ</button></div>
  </div>

  <!-- ç¬¬ä¸‰å…³ï¼šé…å¯¹ -->
  <div class="card" id="panel-l3" style="display:none">
    <h2>ç¬¬ä¸‰å…³ Â· è®°å¿†é…å¯¹ï¼ˆ12å¼ å¡ï¼‰</h2>
    <p class="muted">ä»10æ¡è¯æ¡é‡ŒéšæœºæŠ½6æ¡ï¼Œé…æˆ12å¼ å¡ï¼›æ­¥æ•°è¶Šå°‘è¶Šæ£’ï¼</p>
    <div><span class="badge">æ­¥æ•°ï¼š<span id="moves3">0</span></span></div>
    <div class="board" id="board3"></div>
    <div style="margin-top:8px"><button id="to-l4" disabled>ğŸ¬ å»çœ‹å¥–åŠ±å°è§†é¢‘ âœ</button></div>
  </div>

  <!-- ç¬¬å››å…³ï¼šè§†é¢‘ -->
  <div class="card" id="panel-l4" style="display:none">
    <h2>ç¬¬å››å…³ Â· å¥–åŠ±è§†é¢‘</h2>
    <div class="videoWrap">
      <video id="rewardVideo" controls playsinline webkit-playsinline preload="metadata" poster="çš®å½±_å­¦ç”Ÿè¡¨æ¼”.jpg">
        <!-- åŒ sourceï¼Œå…¼å®¹å¸¦ v=10 ä¸ä¸å¸¦å‚æ•° -->
        <source src="piying_reward.mp4?v=10" type="video/mp4"/>
        <source src="piying_reward.mp4" type="video/mp4"/>
      </video>
      <div id="fallback" class="muted" style="margin-top:8px;display:none">
        è§†é¢‘åŠ è½½é‡åˆ°é—®é¢˜ã€‚ä½ å¯ä»¥
        <a href="piying_reward.mp4" download style="color:#60a5fa">ç‚¹æ­¤ä¸‹è½½</a> æˆ–åˆ·æ–°é‡è¯•ã€‚
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="finalize" class="ghost" disabled>ğŸ… å®Œæˆå¹¶ä¸‹è½½CSV + å‹‹ç« </button>
    </div>
  </div>

  <div class="card">
    <h2>æ’è¡Œæ¦œï¼ˆæœ¬æœºï¼‰</h2>
    <table id="boardT"><thead><tr><th>#</th><th>æ˜µç§°</th><th>å¹´çº§</th><th>ç­çº§</th><th>ç”¨æ—¶(s)</th><th>æ­¥æ•°</th><th>çœ‹è§†é¢‘</th><th>æ—¶é—´</th></tr></thead><tbody></tbody></table>
    <p class="muted" id="bestHint"></p>
  </div>

  <div class="footer">Â© æ ¡å›­éé—æ•™è‚² Â· æ•°æ®ä¿å­˜åœ¨æœ¬æœºï¼Œå¹¶è‡ªåŠ¨ä¸ŠæŠ¥é£ä¹¦</div>
</div>

<script>
/*** ä½ çš„ Vercel åç«¯ï¼ˆé£ä¹¦å†™å…¥å·²åœ¨åç«¯å¤„ç†ï¼‰ ***/
const CLOUD_ENDPOINT = "https://piying-feishu-backend.vercel.app/api/collect";

/*** å·¥å…·ä¸çŠ¶æ€ ***/
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
let timer=null,timeSec=0,v_seen=false;
const STORAGE_KEY="tengchong_heritage_cloud_v4";

/* è¯æ¡ä¸æµç¨‹ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰ */
const FLOW=["å¹²ç‰›çš®","é›•åˆ»","æ¶‚è‰²","è¿æ¥ä»¶","å®‰è£…æ“æ†","å…µå™¨/é…ä»¶"];
const FACTS={
 "å½±çª—":"ç™½å¹•è½½ä½“ï¼Œç¯å…‰è‡ªå¹•åé€è¿‡ï¼Œè§‚ä¼—åœ¨å¹•å‰çœ‹â€œå½±â€ã€‚",
 "ä¸œè…”":"è…¾å†²åœ°æ–¹å”±è…”ä¹‹ä¸€ï¼Œæ—‹å¾‹ä¸å¿µç™½æœ‰åœ°åŸŸé£æ ¼ã€‚",
 "è¥¿è…”":"ä¸ä¸œè…”å¹¶ç§°ï¼Œå¤šè§äºè¥¿éƒ¨ä¹¡é•‡ï¼Œè…”è°ƒæœ‰åˆ«ã€‚",
 "é”£é¼“":"ä¸å”¢å‘ç­‰ç®¡ä¹é…åˆï¼Œçƒ˜æ‰˜èŠ‚å¥ä¸åœºé¢æƒ…ç»ªã€‚",
 "å”¢å‘":"éŸ³è‰²é«˜äº¢å˜¹äº®ï¼Œå¸¸ç”¨äºæ¸²æŸ“æ°”æ°›ä¸è½¬åœºã€‚",
 "é å­":"çš®å½±äººç‰©/é“å…·æœ¬ä½“ï¼Œå¤šç”¨ç‰›çš®é›•åˆ»ä¸Šè‰²ã€‚",
 "æ“æ†":"ç»†ç«¹æ†/æœ¨æ†è”åŠ¨å…³èŠ‚ï¼Œæ˜¯åŠ¨ä½œæ§åˆ¶çš„å…³é”®ã€‚",
 "å‚£æ—èˆå°":"éƒ¨åˆ†åœ°åŒºä¸å‚£æ—æ­ŒèˆåŒåœºæ¼”å‡ºï¼Œèå…¥å¤šæ°‘æ—é£æƒ…ã€‚",
 "æ•…äº‹é¢˜æ":"å¤šå–æã€Šä¸‰å›½ã€‹ã€Šè¥¿æ¸¸ã€‹ï¼Œä¹Ÿæœ‰æœ¬åœ°ä¼ è¯´ã€‚",
 "æ—…æ¸¸æ¼”å‡º":"å¸¸ä¸å¤œå¸‚ã€å¤é•‡å¤œæ¸¸ç»“åˆï¼Œé¢å‘æ¸¸å®¢ä¼ æ’­ã€‚"
};

/*** é¡¶éƒ¨æŒ‰é’®ä¸è®¡æ—¶ ***/
function startTimer(){timeSec=0;$("#time").textContent="0";timer=setInterval(()=>{$("#time").textContent=++timeSec;},1000)}
function stopTimer(){if(timer){clearInterval(timer);timer=null}}
function setDot(n){[$("#d1"),$("#d2"),$("#d3"),$("#d4")].forEach((d,i)=>d.classList.toggle("on",i<n))}
function showPanel(id){["panel-intro","panel-l1","panel-l2","panel-l3","panel-l4"].forEach(pid=>$("#"+pid).style.display=(pid===id?"block":"none"))}

$("#start").onclick=()=>{ if($("#grade").value===""||$("#consent").value!=="æ˜¯"){alert("è¯·å…ˆé€‰æ‹©å¹´çº§å¹¶åŒæ„åŒ¿åæ•°æ®ç”¨äºæ•™å­¦æ”¹è¿›");return}
  $("#reset").disabled=false; setDot(0); startTimer(); showPanel("panel-l1"); initL1();
};
$("#reset").onclick=()=>{ stopTimer(); $("#time").textContent="0"; showPanel("panel-intro"); $("#reset").disabled=true; };
$("#export").onclick=()=>{ const all=loadRecords(); if(!all.length){ alert("æš‚æ— è®°å½•å¯å¯¼å‡º"); return; }
  downloadCSV("è…¾å†²çš®å½±_å…¨éƒ¨è®°å½•.csv", all, ["timestamp","name","grade","class","time_sec","l3_moves","v_seen"]);
};
$("#to-l2").onclick=()=>{ setDot(1); showPanel("panel-l2"); initL2(); };
$("#to-l3").onclick=()=>{ setDot(2); showPanel("panel-l3"); initL3(); };
$("#to-l4").onclick=()=>{ setDot(3); showPanel("panel-l4"); initL4(); };

/*** L1ï¼šé¡ºåºæ‹¼å›¾ï¼ˆå®Œæ•´æ‹–æ‹½ï¼Œä¸æ”¹å˜ç©æ³•ï¼‰ ***/
let current=0;
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function initL1(){
  current=0;
  $$("#slots .stepSlot").forEach((slot,i)=>{
    slot.textContent=`ç¬¬${i+1}æ­¥`; slot.classList.toggle("locked", i>0); slot.classList.toggle("active", i===0);
    slot.classList.remove("good","warn","shake");
    slot.ondragover=e=>e.preventDefault();
    slot.ondrop=e=>{
      e.preventDefault();
      const name=e.dataTransfer.getData("text/plain");
      const idx=+slot.dataset.index;
      if(idx===current && name===FLOW[current]){
        slot.classList.add("good"); slot.classList.remove("active");
        slot.textContent=`ç¬¬${idx+1}æ­¥ï¼š${name} âœ“`;
        const next=$(`#slots .stepSlot[data-index="${idx+1}"]`); if(next){ next.classList.remove("locked"); next.classList.add("active"); }
        const card=[...$("#parts").children].find(x=>x.dataset.name===name); card&&card.remove();
        current++; if(current===FLOW.length) $("#to-l2").disabled=false;
      }else{ slot.classList.add("warn","shake"); setTimeout(()=>slot.classList.remove("shake"),350); }
    };
  });
  const box=$("#parts"); box.innerHTML="";
  shuffle([...FLOW]).forEach(s=>{
    const el=document.createElement("div"); el.className="part"; el.textContent=`æ­¥éª¤ï¼š${s}`; el.draggable=true; el.dataset.name=s;
    el.ondragstart=e=>e.dataTransfer.setData("text/plain", s);
    box.appendChild(el);
  });
}

/*** L2ï¼šè¯æ¡å­¦ä¹ ï¼ˆåŸæœ‰åˆ¤å®šä¿ç•™ï¼‰ ***/
let learned={};
function initL2(){
  learned={}; const grid=$("#infogrid"); grid.innerHTML="";
  Object.keys(FACTS).forEach(k=>{
    const div=document.createElement("div"); div.className="info"; div.dataset.key=k;
    div.innerHTML=`<div class="title">${k}</div><div class="content">${FACTS[k]}</div>`;
    div.onclick=()=>{
      const c=div.querySelector(".content"); c.style.display=(c.style.display==="block")?"none":"block";
      if(!div.classList.contains("learned")){ div.classList.add("learned"); learned[k]=true; }
      $("#to-l3").disabled = Object.keys(learned).length !== Object.keys(FACTS).length;
    };
    grid.appendChild(div);
  });
}

/*** L3ï¼šè®°å¿†é…å¯¹ï¼ˆåŸæœ‰è§„åˆ™ä¿ç•™ï¼‰ ***/
let deck=[],flipped=[],lock=false,matched=0,moves=0;
function initL3(){
  deck=[];flipped=[];lock=false;matched=0;moves=0; $("#moves3").textContent="0"; $("#to-l4").disabled=true;
  const keys = shuffle(Object.keys(FACTS)).slice(0,6); // 6 æ¡
  deck = shuffle(keys.concat(keys)).map((k,i)=>({id:"c"+i, term:k}));
  const b=$("#board3"); b.innerHTML=""; b.style.setProperty("--cols","4");
  deck.forEach(c=>{
    const t=document.createElement("div"); t.className="cardtile"; t.dataset.term=c.term; t.textContent="ç¿»å¼€";
    t.onclick=()=>flip(t); b.appendChild(t);
  });
}
function flip(t){
  if(lock || t.classList.contains("open")) return;
  t.classList.add("open"); t.textContent=t.dataset.term; flipped.push(t);
  $("#moves3").textContent = ++moves;
  if(flipped.length===2){
    const [a,b]=flipped;
    if(a.dataset.term===b.dataset.term){
      flipped=[]; matched++;
      if(matched===6){ $("#to-l4").disabled=false; }
    }else{
      lock=true; setTimeout(()=>{ a.classList.remove("open"); b.classList.remove("open"); a.textContent="ç¿»å¼€"; b.textContent="ç¿»å¼€"; flipped=[]; lock=false; }, 600);
    }
  }
}

/*** L4ï¼šå¥–åŠ±è§†é¢‘ï¼ˆå¢å¼ºå®¹é”™ï¼Œä¸æ”¹è¡Œä¸ºï¼šçœ‹å®Œæ‰å¯å®Œæˆï¼‰ ***/
function initL4(){
  v_seen=false;
  const v=$("#rewardVideo"), fallback=$("#fallback"), btn=$("#finalize");
  fallback.style.display="none"; btn.disabled=true;
  v.load(); // ç¡®ä¿åˆ·æ–° source åé‡æ–°åŠ è½½
  v.play().catch(()=>{});         // æŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼Œä¸å½±å“åç»­
  v.onplay=()=>{ v_seen=true; };
  v.onended=()=>{ btn.disabled=false; };
  v.onerror=()=>{ fallback.style.display="block"; btn.disabled=false; }; // åŠ è½½å¤±è´¥ä¹Ÿå…è®¸ç‚¹å®Œæˆï¼ˆé¿å…è¢«å¡æ­»ï¼‰
}

/*** æœ¬åœ°æ¦œå•/CSV/å‹‹ç« ï¼ˆä¿æŒåŸåŠŸèƒ½ï¼‰ ***/
function loadRecords(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]")}catch{return[]}}
function saveRecords(all){localStorage.setItem(STORAGE_KEY, JSON.stringify(all))}
function saveRecord(r){const all=loadRecords();all.push(r);all.sort((a,b)=>a.time_sec-b.time_sec);saveRecords(all.slice(0,200));}
function refreshBoard(){
  const tb=$("#boardT tbody"); tb.innerHTML="";
  const all=loadRecords().slice(0,200);
  all.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.name||""}</td><td>${r.grade||""}</td><td>${r.class||""}</td><td>${r.time_sec||0}</td><td>${r.l3_moves??""}</td><td>${r.v_seen?"âœ“":""}</td><td>${r.timestamp||""}</td>`;
    tb.appendChild(tr);
  });
  $("#bestHint").textContent = all.length ? `ç›®å‰æœ€å¿«ç”¨æ—¶ï¼š${all[0].time_sec}sï¼ˆ${all[0].name||"åŒ¿å"}ï¼‰` : "æš‚æ— è®°å½•";
}
function downloadCSV(fn, rows, header){
  const out=[header.join(",")];
  rows.forEach(r=> out.push(header.map(k=> String((r[k]??"")).replace(/,/g," ")).join(",")) );
  const blob=new Blob([out.join("\n")],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=fn; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function medalPNG({name,grade,klass,time_sec,moves}){
  const c=document.createElement("canvas"); c.width=900; c.height=600; const x=c.getContext("2d");
  const g=x.createLinearGradient(0,0,900,600); g.addColorStop(0,"#0b1220"); g.addColorStop(1,"#12223f"); x.fillStyle=g; x.fillRect(0,0,900,600);
  x.beginPath(); x.arc(450,220,100,0,Math.PI*2); x.closePath();
  const rg=x.createRadialGradient(450,220,20,450,220,110); rg.addColorStop(0,"#34d399"); rg.addColorStop(1,"#065f46"); x.fillStyle=rg; x.fill();
  x.fillStyle="#e5e7eb"; x.font="bold 54px system-ui"; x.textAlign="center"; x.fillText("é€š å…³", 450, 235);
  x.fillStyle="#93c5fd"; x.font="bold 34px system-ui"; x.fillText("è…¾å†²çš®å½±æˆ Â· éé—æ¢ç§˜é—¯å…³", 450, 60);
  x.fillStyle="#e5e7eb"; x.font="24px system-ui";
  x.fillText(`æ˜µç§°ï¼š${name||"-"}  å¹´çº§ï¼š${grade||"-"}  ç­çº§ï¼š${klass||"-"}  ç”¨æ—¶ï¼š${time_sec||0}s`, 450, 320);
  x.fillText(`ç¬¬ä¸‰å…³æ­¥æ•°ï¼š${moves||0}`, 450, 360);
  x.strokeStyle="#3b82f6"; x.lineWidth=6; x.strokeRect(24,24,852,552);
  const url=c.toDataURL("image/png"); const a=document.createElement("a"); a.href=url; a.download=`çš®å½±æˆé€šå…³å‹‹ç« _${name||"åŒ¿å"}.png`; document.body.appendChild(a); a.click(); a.remove();
}

/*** å®Œæˆå¹¶ä¸ŠæŠ¥ï¼ˆä»… 5 åˆ—ï¼›å…ˆ A å Bï¼›ä¸æ”¹å…¶ä»–ï¼‰ ***/
$("#finalize").onclick=async ()=>{
  stopTimer(); setDot(4);
  const rec={
    timestamp:new Date().toISOString(),   // ä»…æœ¬æœºæ˜¾ç¤º/CSV
    name: ($("#name").value||"").replace(/,/g," "),
    grade: $("#grade").value,
    class: ($("#klass").value||"").replace(/,/g," "),
    time_sec: timeSec,
    l3_moves: Number($("#moves3").textContent)||0,
    v_seen: v_seen
  };

  // æœ¬æœºä¿å­˜ä¸æ¦œå•
  saveRecord(rec); refreshBoard();

  // â€”â€” æŒ‰ä½ å®šçš„åè®®ï¼šåªå†™ 5 åˆ—ï¼›ä¸¤ç§è¯·æ±‚ä½“éƒ½å¯è¢«åç«¯æ¥å— â€”â€”
  const payloadA = {
    fields:{
      "æ˜µç§°": rec.name,
      "å¹´çº§": rec.grade,
      "ç­çº§": rec.class,
      "ç¬¬3å…³æ­¥æ•°": rec.l3_moves,
      "æ˜¯å¦çœ‹è§†é¢‘": rec.v_seen ? "æ˜¯" : "å¦"
    }
  };
  const payloadB = {
    name: rec.name,
    grade: rec.grade,
    class: rec.class,
    l3_moves: rec.l3_moves,
    v_seen: rec.v_seen
  };

  let ok=false, step="A";
  try{
    let resp = await fetch(CLOUD_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadA) });
    let j = await resp.json().catch(()=>({}));
    if(resp.ok && j && j.ok){ ok=true; step="A"; }
    else{
      resp = await fetch(CLOUD_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payloadB) });
      j = await resp.json().catch(()=>({}));
      if(resp.ok && j && j.ok){ ok=true; step="B"; }
    }
  }catch(_){}

  alert(ok ? ("âœ… è®°å½•å·²ä¸ŠæŠ¥é£ä¹¦ï¼ˆ"+step+"ï¼‰ã€‚") : "ç½‘ç»œå¼‚å¸¸æˆ–åç«¯æœªå°±ç»ªï¼ˆæœ¬æœºå·²ä¿å­˜ï¼Œå¯ç¨åå†å¼€æ­¤é¡µè‡ªåŠ¨è¡¥ä¼ ï¼‰ã€‚");

  // å‹‹ç«  & å•æ¡CSVï¼ˆä¿ç•™ï¼‰
  medalPNG({name:rec.name,grade:rec.grade,klass:rec.class,time_sec:rec.time_sec,moves:rec.l3_moves});
  const header=["timestamp","name","grade","class","time_sec","l3_moves","v_seen"];
  const blob=new Blob([[header.join(",")],[header.map(k=>String((rec[k]??"")).replace(/,/g," ")).join(",")]].join("\n"), {type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="è…¾å†²çš®å½±_å•æ¡è®°å½•.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/*** åˆå§‹åŒ– ***/
function setDot(n){[$("#d1"),$("#d2"),$("#d3"),$("#d4")].forEach((d,i)=>d.classList.toggle("on",i<n))}
function refreshBoardInit(){ // å¯åŠ¨æ—¶åˆ·æ–°æ¦œå•
  const all=loadRecords(); const tb=$("#boardT tbody"); tb.innerHTML="";
  all.forEach((r,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${r.name||""}</td><td>${r.grade||""}</td><td>${r.class||""}</td><td>${r.time_sec||0}</td><td>${r.l3_moves??""}</td><td>${r.v_seen?"âœ“":""}</td><td>${r.timestamp||""}</td>`;tb.appendChild(tr);});
  $("#bestHint").textContent = all.length ? `ç›®å‰æœ€å¿«ç”¨æ—¶ï¼š${all[0].time_sec}sï¼ˆ${all[0].name||"åŒ¿å"}ï¼‰` : "æš‚æ— è®°å½•";
}
refreshBoardInit(); showPanel("panel-intro");
</script>
</body>
</html>
