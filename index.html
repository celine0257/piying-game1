<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è…¾å†²çš®å½±æˆ Â· åˆ¶ä½œæ­¥éª¤ + è¯æ¡å­¦ä¹  + è®°å¿†é…å¯¹</title>
<style>
:root{ --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; --ok:#34d399; --warn:#f59e0b;}
*{box-sizing:border-box} body{margin:0; font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei",Arial; background:var(--bg); color:var(--ink);}
.wrap{max-width:1100px; margin:0 auto; padding:18px;}
.card{background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); margin-bottom:14px;}
h1,h2{margin:0 0 12px} .muted{color:var(--muted); font-size:14px}
input,select,button{border-radius:12px; border:1px solid #1f2937; padding:10px 12px; background:#0b1220; color:#fff;}
button{background:var(--brand); color:#09111f; font-weight:700; cursor:pointer; border:none}
button.ghost{background:#0b1220; color:#fff; border:1px solid #374151}
button:disabled{opacity:.5; cursor:not-allowed}
.topbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.badge{font-size:12px; background:#0b1220; border:1px solid #374151; padding:2px 10px; border-radius:999px; color:#cbd5e1}
.progress{display:flex; gap:4px; align-items:center}
.dot{width:10px; height:10px; border-radius:50%; background:#1f2937; display:inline-block}
.dot.on{background:linear-gradient(180deg,#a7f3d0,#10b981)}
.gallery{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.gallery img{width:100%; height:240px; object-fit:cover; border-radius:12px; border:1px solid #374151}
.gallery .span2{grid-column:1 / span 2; height:280px}
.cap{font-size:12px; color:#cbd5e1; margin:6px 2px 0}

/* L1 åˆ¶ä½œæ­¥éª¤ï¼ˆé¡ºåºæ‹¼å›¾ï¼‰ */
.timeline{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:10px}
.stepSlot{min-height:72px; display:flex; align-items:center; justify-content:center; border:2px dashed #374151; border-radius:12px; color:#94a3b8; background:#0b1220}
.stepSlot.locked{opacity:.6; filter:grayscale(30%);}
.stepSlot.active{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.3) inset;}
.part{user-select:none; margin:8px 0; padding:10px 12px; background:#0f172a; border:1px solid #1f2937; border-radius:12px; cursor:grab}
.partsBox{background:#0b1220; border:1px solid #374151; border-radius:16px; padding:12px}
.good{outline:2px solid var(--ok)} .warn{outline:2px solid var(--warn)}

/* L2 è¯æ¡å­¦ä¹  */
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
.info{background:#0b1220; border:1px solid #374151; border-radius:14px; padding:12px; cursor:pointer}
.info .title{font-weight:700; margin-bottom:6px}
.info .content{display:none; font-size:13px; color:#cbd5e1}
.info.learned{outline:2px solid var(--ok)}

/* L3 è®°å¿†é…å¯¹ï¼ˆ5å¯¹ï¼‰ */
.board{--cols:4; display:grid; grid-template-columns:repeat(var(--cols),1fr); gap:10px}
.cardtile{height:90px; background:#0b1220; border:1px solid #374151; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700}
.cardtile.open{background:linear-gradient(135deg,#0b1220,#0f172a)}
table{width:100%; border-collapse:collapse; font-size:14px; margin-top:8px}
th,td{border-bottom:1px solid #223; padding:8px; text-align:left}
.footer{font-size:12px; color:#9ca3af; text-align:center; margin-top:8px}
.note{font-size:13px; color:#cbd5e1; background:#0b1220; border:1px dashed #374151; padding:10px 12px; border-radius:12px}

/* â€”â€” éŸ³æ•ˆ/åŠ¨ç”»å¢å¼º â€”â€” */
@keyframes shakeX {
  10%, 90% { transform: translateX(-2px); }
  20%, 80% { transform: translateX(4px); }
  30%, 50%, 70% { transform: translateX(-6px); }
  40%, 60% { transform: translateX(6px); }
}
.shake { animation: shakeX .35s ease; }
.flash {
  box-shadow: 0 0 0 2px rgba(52,211,153,.45) inset, 0 0 16px rgba(52,211,153,.35);
  transition: box-shadow .4s;
}
</style>
</head>
<body>
<div class="wrap">

  <!-- é¡¶éƒ¨ -->
  <div class="card">
    <h1>è…¾å†²çš®å½±æˆ Â· åˆ¶ä½œæ­¥éª¤ + è¯æ¡å­¦ä¹  + è®°å¿†é…å¯¹</h1>
    <p class="muted">â‘ åˆ¶ä½œæ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ”¾ç½®ï¼‰ â†’ â‘¡å­¦ä¹ 10æ¡è¯æ¡ â†’ â‘¢è®°å¿†é…å¯¹ï¼ˆ5å¯¹ï¼‰ã€‚å®Œæˆåè‡ªåŠ¨ä¸‹è½½CSVä¸å‹‹ç« ã€‚</p>
    <div class="topbar">
      <label>æ˜µç§° <input id="name" placeholder="å¦‚ï¼šäº”ï¼ˆä¸‰ï¼‰-29"></label>
      <label>å¹´çº§ <select id="grade"><option value="">è¯·é€‰æ‹©</option><option>ä¸€å¹´çº§</option><option>äºŒå¹´çº§</option><option>ä¸‰å¹´çº§</option><option>å››å¹´çº§</option><option>äº”å¹´çº§</option><option>å…­å¹´çº§</option></select></label>
      <label>ç­çº§ <input id="klass" placeholder="å¦‚ï¼šäº”ï¼ˆä¸‰ï¼‰ç­"></label>
      <label>åŒæ„åŒ¿åæ•°æ® <select id="consent"><option>æ˜¯</option><option>å¦</option></select></label>
      <span class="badge">ç”¨æ—¶ï¼š<span id="time">0</span>s</span>
      <div class="progress"><span class="badge">è¿›åº¦</span><span class="dot" id="d1"></span><span class="dot" id="d2"></span><span class="dot" id="d3"></span></div>
      <button id="start">å¼€å§‹</button>
      <button id="reset" class="ghost" disabled>é‡æ¥</button>
      <button id="export" class="ghost">å¯¼å‡ºå…¨éƒ¨CSV</button>
    </div>
  </div>

  <!-- å±•æ¿ï¼š4å¼ å›¾ -->
  <div class="card" id="panel-intro">
    <h2>å¼€åœºå±•æ¿</h2>
    <div class="gallery">
      <div class="span2">
        <img src="æ ¡å¾½.png" alt="å­¦æ ¡æ ‡è¯†">
        <div class="cap">äº‘å—å¸ˆå¤§é™„å°ï¼šéé—è¿›æ ¡å›­ï¼Œçš®å½±æˆâ€œçœ‹å¾—è§ã€ç©å¾—èµ·ã€è¯´å¾—å‡ºâ€ã€‚</div>
      </div>
      <div>
        <img src="çš®å½±_æ ‘ä¸‹å¯¹å.jpg" alt="çš®å½±è¡¨æ¼”Â·æ ‘ä¸‹å¯¹å">
        <div class="cap">å½±çª—ï¼ˆç™½å¹•ï¼‰+èƒŒåç¯å…‰ï¼Œæ¼”å‘˜åœ¨å¹•åæ“æ†ï¼Œè§‚ä¼—åœ¨å¹•å‰çœ‹â€œå½±â€ã€‚</div>
      </div>
      <div>
        <img src="çš®å½±_å­¦ç”Ÿè‡ªåˆ¶.jpg" alt="å­¦ç”Ÿè‡ªåˆ¶çš®å½±">
        <div class="cap">é å­ä¼ ç»Ÿå¤šç”¨ç‰›çš®é›•åˆ»ï¼›æ ¡å›­ä½“éªŒå¯ç”¨å¡çº¸/PPç‰‡äº†è§£ç»“æ„ä¸è¿æ¥ã€‚</div>
      </div>
      <div>
        <img src="çš®å½±_å­¦ç”Ÿè¡¨æ¼”.jpg" alt="å­¦ç”Ÿè¡¨æ¼”çš®å½±">
        <div class="cap">ç»†ç«¹æ†è”åŠ¨å…³èŠ‚ï¼›é”£é¼“å”¢å‘é…åˆèŠ‚å¥ï¼Œè…¾å†²æœ‰ä¸œè…”/è¥¿è…”ç­‰é£æ ¼ã€‚</div>
      </div>
    </div>
    <p class="note">ä»»åŠ¡ï¼šâ‘ åˆ¶ä½œæ­¥éª¤ï¼ˆé¡ºåºï¼‰ â†’ â‘¡å­¦ä¹ 10æ¡ â†’ â‘¢é…å¯¹5å¯¹</p>
  </div>

  <!-- L1 åˆ¶ä½œæ­¥éª¤ï¼ˆé¡ºåºæ‹¼å›¾ï¼‰ -->
  <div class="card" id="panel-l1" style="display:none">
    <h2>å…³å¡ä¸€ Â· å¦‚ä½•åˆ¶ä½œä¸€ä¸ªçš®å½±ï¼ˆé¡ºåºæ‹¼å›¾ï¼‰</h2>
    <p class="muted">è¯·æŒ‰é¡ºåºæŠŠ<strong>ä¸‹ä¸€æ­¥</strong>æ‹–åˆ°å¯¹åº”æ§½ä½ï¼ˆåªèƒ½æ”¾å¯¹å½“å‰è¿™ä¸€æ­¥ï¼‰ã€‚</p>
    <div class="timeline" id="slots">
      <div class="stepSlot" data-index="0">ç¬¬1æ­¥</div>
      <div class="stepSlot locked" data-index="1">ç¬¬2æ­¥</div>
      <div class="stepSlot locked" data-index="2">ç¬¬3æ­¥</div>
      <div class="stepSlot locked" data-index="3">ç¬¬4æ­¥</div>
      <div class="stepSlot locked" data-index="4">ç¬¬5æ­¥</div>
      <div class="stepSlot locked" data-index="5">ç¬¬6æ­¥</div>
    </div>
    <div class="partsBox" id="parts"></div>
    <div class="topbar" style="margin-top:8px">
      <button id="to-l2" class="ghost" disabled>æ­¥éª¤å®Œæˆï¼Œè¿›å…¥è¯æ¡å­¦ä¹  âœ</button>
    </div>
  </div>

  <!-- L2 è¯æ¡å­¦ä¹ ï¼ˆ10æ¡å…¨éƒ¨ç‚¹äº®ï¼‰ -->
  <div class="card" id="panel-l2" style="display:none">
    <h2>å…³å¡äºŒ Â· å­¦ä¹ çŸ¥è¯†è¯æ¡ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</h2>
    <p class="muted">ç‚¹å‡»æ¯å¼ å¡ç‰‡æŸ¥çœ‹å°çŸ¥è¯†ï¼Œå…¨éƒ¨ç‚¹äº®åå¯è¿›å…¥è®°å¿†é…å¯¹ã€‚</p>
    <div class="grid" id="infogrid"></div>
    <div class="topbar" style="margin-top:8px">
      <button id="to-l3" class="ghost" disabled>å·²ç‚¹äº®10æ¡ï¼Œå¼€å§‹é…å¯¹æŒ‘æˆ˜ âœ</button>
    </div>
  </div>

  <!-- L3 è®°å¿†é…å¯¹ï¼ˆ5å¯¹ï¼‰ -->
  <div class="card" id="panel-l3" style="display:none">
    <h2>å…³å¡ä¸‰ Â· è®°å¿†é…å¯¹ï¼ˆ5å¯¹ï¼‰</h2>
    <p class="muted">ä»10æ¡è¯æ¡é‡ŒéšæœºæŠ½5æ¡ï¼Œé…æˆ10å¼ å¡ï¼›æ­¥æ•°è¶Šå°‘è¶Šæ£’ï¼</p>
    <div class="topbar"><span class="badge">æ­¥æ•°ï¼š<span id="moves3">0</span></span></div>
    <div class="board" id="board3"></div>
    <div class="topbar" style="margin-top:8px">
      <button id="finish" disabled>ğŸ‰ å®Œæˆå¹¶ç”ŸæˆCSV</button>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œ -->
  <div class="card">
    <h2>æ’è¡Œæ¦œï¼ˆæœ¬æœºï¼‰</h2>
    <table id="boardT">
      <thead><tr><th>æ˜µç§°</th><th>å¹´çº§</th><th>ç­çº§</th><th>ç”¨æ—¶(s)</th><th>L1å®Œæˆ</th><th>L2ç‚¹äº®</th><th>L3æ­¥æ•°</th><th>æ—¶é—´</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">Â© æ ¡å›­éé—æ•™è‚² Â· æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ Â· å¯å¯¼å‡ºCSVæ±‡æ€»</div>
</div>

<script>
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
let timer=null,timeSec=0,started=false, l1_ok=false, l2_ok=false;
const STORAGE_KEY="tengchong_three_stages_seq_sfx_v1";

function startTimer(){timeSec=0;$("#time").textContent="0";timer=setInterval(()=>{timeSec++;$("#time").textContent=timeSec;},1000);}
function stopTimer(){if(timer){clearInterval(timer);timer=null;}}
function setDot(n){[$("#d1"),$("#d2"),$("#d3")].forEach((d,i)=>d.classList.toggle("on",i<n));}
function showPanel(id){["panel-intro","panel-l1","panel-l2","panel-l3"].forEach(pid=>$("#"+pid).style.display=(pid===id?"block":"none"));}

/* â€”â€” æ•°æ®é›† â€”â€” */
const FLOW=["å¹²ç‰›çš®","é›•åˆ»","æ¶‚è‰²","è¿æ¥ä»¶","å®‰è£…æ“æ†","å…µå™¨/é…ä»¶"]; // æ­£ç¡®é¡ºåº
const FACTS={ // 10æ¡ï¼ˆæ— â€œç¯å…‰â€â€œç«æŠŠèŠ‚â€ï¼‰
 "å½±çª—":"ç™½å¹•è½½ä½“ï¼Œç¯å…‰è‡ªå¹•åé€è¿‡ï¼Œè§‚ä¼—åœ¨å¹•å‰çœ‹â€œå½±â€ã€‚",
 "ä¸œè…”":"è…¾å†²åœ°æ–¹å”±è…”ä¹‹ä¸€ï¼Œæ—‹å¾‹ä¸å¿µç™½æœ‰åœ°åŸŸé£æ ¼ã€‚",
 "è¥¿è…”":"ä¸ä¸œè…”å¹¶ç§°ï¼Œå¤šè§äºè¥¿éƒ¨ä¹¡é•‡ï¼Œè…”è°ƒæœ‰åˆ«ã€‚",
 "é”£é¼“":"ä¸å”¢å‘ç­‰ç®¡ä¹é…åˆï¼Œçƒ˜æ‰˜èŠ‚å¥ä¸åœºé¢æƒ…ç»ªã€‚",
 "å”¢å‘":"éŸ³è‰²é«˜äº¢å˜¹äº®ï¼Œå¸¸ç”¨äºæ¸²æŸ“æ°”æ°›ä¸è½¬åœºã€‚",
 "é å­":"çš®å½±äººç‰©/é“å…·æœ¬ä½“ï¼Œå¤šç”¨ç‰›çš®é›•åˆ»ä¸Šè‰²ã€‚",
 "æ“æ†":"ç»†ç«¹æ†/æœ¨æ†è”åŠ¨å…³èŠ‚ï¼Œæ˜¯åŠ¨ä½œæ§åˆ¶çš„å…³é”®ã€‚",
 "å‚£æ—èˆå°":"è…¾å†²éƒ¨åˆ†åœ°åŒºçš®å½±å¸¸ä¸å‚£æ—æ­ŒèˆåŒåœºæ¼”å‡ºï¼Œèå…¥å¤šæ°‘æ—é£æƒ…ã€‚",
 "æ•…äº‹é¢˜æ":"å¤šå–æäºã€Šä¸‰å›½ã€‹ã€Šè¥¿æ¸¸ã€‹ï¼Œä¹Ÿæœ‰æœ¬åœ°ä¼ è¯´å¦‚â€œè…¾è¶Šé£äº‘â€ã€‚",
 "æ—…æ¸¸æ¼”å‡º":"å¸¸ä¸æ—…æ¸¸å¤œå¸‚ã€å¤é•‡å¤œæ¸¸ç»“åˆï¼Œæˆä¸ºæ–‡åŒ–ä¼ æ’­æ–¹å¼ã€‚"
};
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

/* ===== éŸ³æ•ˆï¼ˆWebAudioåˆæˆï¼‰ ===== */
let audioCtx=null;
function getCtx(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } return audioCtx; }
function beep({freq=880, dur=0.15, type="sine", vol=0.2, decay=0.03}={}){
  const ctx=getCtx();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.value=vol; g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur-decay);
  o.connect(g).connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime+dur);
}
function playGood(){ beep({freq:880,type:"triangle",dur:0.12,vol:0.25}); setTimeout(()=>beep({freq:1200,type:"triangle",dur:0.12,vol:0.22}),90); }
function playBad(){  beep({freq:200,type:"sawtooth",dur:0.18,vol:0.18}); }
function playWin(){  [0,120,220,320].forEach((d,i)=> setTimeout(()=>beep({freq:700+ i*150,type:"square",dur:0.12,vol:0.25}), d)); }

/* ===== è½»é‡å½©å¸¦ ===== */
function confettiBurst(times=24){
  const c=document.createElement("canvas"); c.style.position="fixed"; c.style.inset="0"; c.style.pointerEvents="none"; c.width=innerWidth; c.height=innerHeight; document.body.appendChild(c);
  const ctx=c.getContext("2d"); const pieces=[];
  for(let i=0;i<times;i++){
    pieces.push({x:Math.random()*c.width, y:-20, r:4+Math.random()*6, vy:2+Math.random()*3, vx:(Math.random()*2-1)*2, rot:Math.random()*Math.PI, vr:(Math.random()*.2-.1)});
  }
  let t=0; const id=setInterval(()=>{ t++; ctx.clearRect(0,0,c.width,c.height);
    pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillStyle=`hsl(${(p.x+p.y)%360},85%,60%)`; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore(); });
    if(t>120) { clearInterval(id); c.remove(); }
  }, 16);
}

/* ===== é€šå…³ç”µå­å‹‹ç« ï¼ˆPNGï¼‰ ===== */
function makeMedalPNG({name, grade, klass, time_sec, steps, moves}){
  const canvas=document.createElement("canvas"); canvas.width=900; canvas.height=600;
  const ctx=canvas.getContext("2d");
  const g=ctx.createLinearGradient(0,0,900,600); g.addColorStop(0,"#0b1220"); g.addColorStop(1,"#12223f"); ctx.fillStyle=g; ctx.fillRect(0,0,900,600);
  ctx.beginPath(); ctx.arc(450,220,100,0,Math.PI*2); ctx.closePath();
  const rg=ctx.createRadialGradient(450,220,20,450,220,110); rg.addColorStop(0,"#34d399"); rg.addColorStop(1,"#065f46"); ctx.fillStyle=rg; ctx.fill();
  ctx.fillStyle="#e5e7eb"; ctx.font="bold 54px system-ui"; ctx.textAlign="center"; ctx.fillText("é€š å…³", 450, 235);
  ctx.fillStyle="#93c5fd"; ctx.font="bold 34px system-ui"; ctx.fillText("è…¾å†²çš®å½±æˆ Â· åˆ¶ä½œæ­¥éª¤ + è¯æ¡å­¦ä¹  + è®°å¿†é…å¯¹", 450, 60);
  ctx.fillStyle="#e5e7eb"; ctx.font="24px system-ui";
  ctx.fillText(`æ˜µç§°ï¼š${name||"-"}  å¹´çº§ï¼š${grade||"-"}  ç­çº§ï¼š${klass||"-"}`, 450, 320);
  ctx.fillText(`æ€»ç”¨æ—¶ï¼š${time_sec||0}s   L1æ­¥éª¤ï¼š${steps||"âœ“"}   L3æ­¥æ•°ï¼š${moves||0}`, 450, 360);
  ctx.fillStyle="#9ca3af"; ctx.font="20px system-ui"; ctx.fillText(`äº‘å—å¸ˆå¤§é™„å° Â· éé—è¿›æ ¡å›­`, 450, 400);
  ctx.strokeStyle="#3b82f6"; ctx.lineWidth=6; ctx.strokeRect(24,24,900-48,600-48);
  const url=canvas.toDataURL("image/png");
  const a=document.createElement("a"); a.href=url; a.download=`çš®å½±æˆé€šå…³å‹‹ç« _${name||"åŒ¿å"}.png`; document.body.appendChild(a); a.click(); a.remove();
}

/* ===== L1 åˆ¶ä½œæ­¥éª¤ï¼ˆé¡ºåºåˆ¤å®š + åº•éƒ¨éšæœºï¼‰ ===== */
let currentStepIndex=0;
function initL1(){
  l1_ok=false; currentStepIndex=0;
  $$("#slots .stepSlot").forEach((slot,i)=>{
    slot.textContent = `ç¬¬${i+1}æ­¥`;
    slot.classList.toggle("locked", i>0);
    slot.classList.toggle("active", i===0);
    slot.classList.remove("good","warn");
    slot.addEventListener("dragover", e=> e.preventDefault());
    slot.addEventListener("drop", e=>{
      e.preventDefault();
      const name=e.dataTransfer.getData("text/plain");
      const idx = Number(slot.dataset.index);
      if(idx===currentStepIndex && name===FLOW[currentStepIndex]){
        slot.classList.add("good","flash"); setTimeout(()=>slot.classList.remove("flash"),400);
        slot.textContent = `ç¬¬${idx+1}æ­¥ï¼š${name} âœ“`;
        playGood();
        slot.classList.remove("active");
        const next = $(`#slots .stepSlot[data-index="${idx+1}"]`);
        if(next){ next.classList.remove("locked"); next.classList.add("active"); }
        const partEl=Array.from($("#parts").children).find(x=>x.dataset && x.dataset.name===name);
        if(partEl) partEl.remove();
        currentStepIndex++;
        if(currentStepIndex===FLOW.length){ $("#to-l2").disabled=false; l1_ok=true; }
      }else{
        slot.classList.add("warn","shake"); setTimeout(()=>slot.classList.remove("shake"),350);
        playBad();
      }
    });
  });
  const parts=$("#parts"); parts.innerHTML="";
  shuffle([...FLOW]).forEach(step=>{
    const el=document.createElement("div"); el.className="part"; el.textContent=`æ­¥éª¤ï¼š${step}`;
    el.draggable=true; el.dataset.name=step;
    el.addEventListener("dragstart", e=> e.dataTransfer.setData("text/plain", step));
    parts.appendChild(el);
  });
}

/* ===== L2 è¯æ¡å­¦ä¹ ï¼ˆéœ€å…¨éƒ¨ç‚¹äº®ï¼‰ ===== */
let learned={};
function initL2(){
  l2_ok=false; learned={};
  const grid=$("#infogrid"); grid.innerHTML="";
  Object.keys(FACTS).forEach(key=>{
    const div=document.createElement("div"); div.className="info"; div.dataset.key=key;
    div.innerHTML=`<div class="title">${key}</div><div class="content">${FACTS[key]}</div>`;
    div.addEventListener("click", ()=>{
      const c=div.querySelector(".content");
      c.style.display = (c.style.display==="block") ? "none" : "block";
      if(!div.classList.contains("learned")){ div.classList.add("learned"); learned[key]=true; }
      const allOk = Object.keys(learned).length === Object.keys(FACTS).length;
      $("#to-l3").disabled = !allOk;
      if(allOk){ playGood(); l2_ok=true; }
    });
    grid.appendChild(div);
  });
}

/* ===== L3 è®°å¿†é…å¯¹ï¼ˆ5å¯¹ï¼Œä»10æ¡éšæœºæŠ½ï¼‰ ===== */
let deck3=[],matched3=0,flipped3=[],lock3=false,moves3=0;
function initL3(){
  matched3=0; flipped3=[]; lock3=false; moves3=0; $("#moves3").textContent="0"; $("#finish").disabled=true;
  const keys = shuffle(Object.keys(FACTS)).slice(0,5); // 5 æ¡ â†’ 5 å¯¹
  deck3 = shuffle(keys.concat(keys)).map((k,i)=>({id:"m3_"+i, term:k}));
  const board=$("#board3"); board.innerHTML=""; board.style.setProperty("--cols","4");
  deck3.forEach(c=>{
    const t=document.createElement("div"); t.className="cardtile"; t.dataset.term=c.term; t.textContent="ç¿»å¼€";
    t.addEventListener("click", ()=> flip3(t)); board.appendChild(t);
  });
}
function flip3(t){
  if(lock3 || t.classList.contains("open")) return;
  t.classList.add("open"); t.textContent=t.dataset.term; flipped3.push(t);
  moves3++; $("#moves3").textContent=moves3;
  if(flipped3.length===2){
    const [a,b]=flipped3;
    if(a.dataset.term===b.dataset.term){
      flipped3=[]; matched3++; playGood();
      if(matched3===5){
        $("#finish").disabled=false;
        playWin(); confettiBurst(36);
      }
    }else{
      lock3=true; setTimeout(()=>{ a.classList.remove("open"); b.classList.remove("open");
        a.textContent="ç¿»å¼€"; b.textContent="ç¿»å¼€"; flipped3=[]; lock3=false; },600);
    }
  }
}

/* ===== æ’è¡Œ & CSV ===== */
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; } }
function saveRecord(rec){ const all=loadRecords(); all.unshift(rec); localStorage.setItem(STORAGE_KEY, JSON.stringify(all.slice(0,200))); }
function refreshBoard(){
  const tb=$("#boardT tbody"); tb.innerHTML="";
  loadRecords().slice(0,20).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${r.name||""}</td><td>${r.grade||""}</td><td>${r.class||""}</td><td>${r.time_sec||0}</td><td>${r.l1_ok?"âœ“":""}</td><td>${r.l2_ok?"âœ“":""}</td><td>${r.l3_moves??""}</td><td>${r.timestamp||""}</td>`;
    tb.appendChild(tr);
  });
}
function downloadCSV(filename, rows, header){
  const csvRows=[]; csvRows.push(header.join(","));
  rows.forEach(r=> csvRows.push(header.map(k=> String((r[k]??"")).replace(/,/g," ")).join(",")) );
  const blob=new Blob([csvRows.join("\n")],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== äº‹ä»¶ç»‘å®š ===== */
$("#start").addEventListener("click", ()=>{
  if(started) return;
  if($("#grade").value==="" || $("#consent").value!=="æ˜¯"){ alert("è¯·å…ˆé€‰æ‹©å¹´çº§å¹¶åŒæ„åŒ¿åæ•°æ®ç”¨äºæ•™å­¦æ”¹è¿›"); return; }
  started=true; setDot(0); $("#reset").disabled=false; startTimer();
  showPanel("panel-l1"); initL1();
});
$("#reset").addEventListener("click", ()=>{
  stopTimer(); started=false; setDot(0); $("#time").textContent="0";
  showPanel("panel-intro"); $("#reset").disabled=true;
});
$("#export").addEventListener("click", ()=>{
  const all=loadRecords(); if(!all.length){ alert("æš‚æ— è®°å½•å¯å¯¼å‡º"); return; }
  downloadCSV("è…¾å†²çš®å½±_åˆ¶ä½œè¯æ¡é…å¯¹_å…¨éƒ¨è®°å½•.csv", all,
    ["timestamp","name","grade","class","time_sec","l1_ok","l2_ok","l3_moves"]);
});

$("#to-l2").addEventListener("click", ()=>{ setDot(1); showPanel("panel-l2"); initL2(); });
$("#to-l3").addEventListener("click", ()=>{ setDot(2); showPanel("panel-l3"); initL3(); });
$("#finish").addEventListener("click", ()=>{
  stopTimer(); setDot(3);
  const rec={
    timestamp:new Date().toISOString(),
    name: ($("#name").value||"").replace(/,/g," "),
    grade: $("#grade").value,
    class: ($("#klass").value||"").replace(/,/g," "),
    time_sec: timeSec,
    l1_ok: l1_ok,
    l2_ok: l2_ok,
    l3_moves: Number($("#moves3").textContent)||0
  };
  saveRecord(rec); refreshBoard();
  downloadCSV("è…¾å†²çš®å½±_åˆ¶ä½œè¯æ¡é…å¯¹_å•æ¡è®°å½•.csv", [rec],
    ["timestamp","name","grade","class","time_sec","l1_ok","l2_ok","l3_moves"]);
  // ç”µå­å‹‹ç« 
  makeMedalPNG({
    name: $("#name").value,
    grade: $("#grade").value,
    klass: $("#klass").value,
    time_sec: timeSec,
    steps: "6/6",
    moves: Number($("#moves3").textContent)||0
  });
  alert("ğŸ‰ æ­å–œé€šå…³ï¼å·²ç”Ÿæˆä½ çš„CSVä¸å‹‹ç« å›¾ç‰‡ã€‚");
});

/* åˆå§‹åŒ– */
refreshBoard(); showPanel("panel-intro");
</script>
</body>
</html>