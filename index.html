<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"
  />
  <title>腾冲皮影戏 · 云上小剧场｜信息填写 · 计时 · 提交</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--accent:#38bdf8;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --btn:#2563eb;--btn-hover:#1d4ed8;--ghost:#e5e7eb;--ghost-t:#0b1220;
      --ring:0 0 0 4px rgb(56 189 248 / .25)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0b1220,#0b1220 30%,#111827 100%) fixed;
      color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:grid;place-items:start center; padding:24px;
    }
    .shell{width:min(980px,100%);margin-inline:auto}
    .card{
      background:linear-gradient(180deg,#0f172a 0%,#0b1220 100%);
      border:1px solid rgba(148,163,184,.18); border-radius:18px; padding:24px; box-shadow:0 18px 60px rgba(2,6,23,.55)
    }
    header h1{margin:0 0 8px;font-size:28px;letter-spacing:.5px}
    header p{margin:0;color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media (min-width:740px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:repeat(3,1fr)} }
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0}
    input,select{
      width:100%; background:#0b1220; color:var(--text);
      border:1px solid rgba(148,163,184,.3); border-radius:12px; padding:12px 14px; outline:none
    }
    input:focus,select:focus{border-color:var(--accent); box-shadow:var(--ring)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 16px; cursor:pointer;
      color:#fff; background:var(--btn); font-weight:600
    }
    .btn:hover{background:var(--btn-hover)}
    .ghost{
      background:var(--ghost); color:var(--ghost-t); border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; border:0
    }
    .timer{
      display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:12px;
      background:#0b1220; border:1px dashed rgba(148,163,184,.35)
    }
    .big{font-size:32px; font-weight:800; letter-spacing:1px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .hr{height:1px; background:rgba(148,163,184,.15); margin:24px 0}
    .note{font-size:14px; color:var(--muted)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid rgba(148,163,184,.25);border-radius:999px;color:var(--muted)}
    .foot{opacity:.9}
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <header>
        <h1>腾冲皮影戏 · 云上小剧场</h1>
        <p>填写基本信息 → <b>开始计时</b> → <b>进入游戏演练</b>（原音效/奖励照常）→ 返回 <b>提交成绩</b>，数据会写入飞书表。</p>
      </header>

      <!-- 信息表单 -->
      <section class="grid grid-3" style="margin-top:12px">
        <div><label>昵称/姓名</label><input id="name" placeholder="例如：小明" /></div>
        <div><label>年级</label>
          <select id="grade">
            <option value="" disabled selected>请选择</option>
            <option>一年级</option><option>二年级</option><option>三年级</option>
            <option>四年级</option><option>五年级</option><option>六年级</option>
          </select>
        </div>
        <div><label>班级</label><input id="klass" placeholder="例如：3班" /></div>
      </section>

      <section class="grid grid-3" style="margin-top:12px">
        <div><label>第3关步数（可选）</label><input id="moves" type="number" inputmode="numeric" min="0" placeholder="例如：8" /></div>
        <div><label>是否看视频（单选）</label>
          <select id="vseen">
            <option value="未选择" disabled selected>请选择</option>
            <option>是</option><option>否</option>
          </select>
        </div>
        <div class="note" style="display:flex;align-items:flex-end">若扫码网址带 ?grade=六年级&class=3班&name=张三，可自动填充。</div>
      </section>

      <div class="hr"></div>

      <!-- 计时器 -->
      <section class="grid grid-2">
        <div class="timer"><span class="muted">用时</span><span id="clock" class="big">00:00</span><span id="sec" class="muted">0 秒</span></div>
        <div class="row">
          <button class="ghost" id="btnStart">▶ 开始</button>
          <button class="ghost" id="btnPause">⏸ 暂停</button>
          <button class="ghost" id="btnReset">⟲ 归零</button>
        </div>
      </section>

      <div class="row" style="margin-top:16px">
        <!-- 进入游戏：保留原音效/奖励页面 -->
        <a href="./reward.html" class="ghost" id="btnGame" style="text-decoration:none">🎮 进入游戏（保留音效与奖励）</a>
        <button class="btn" id="btnSubmit">✅ 提交成绩</button>
        <span id="tip" class="pill">状态：等待提交</span>
      </div>

      <div class="hr"></div>

      <!-- 学生自制与展演说明 -->
      <section>
        <h3 style="margin:0 0 8px">学生自制皮影与展演说明</h3>
        <ol class="note" style="margin:8px 0 0 16px">
          <li>请使用身边材料（纸板、吸管、硬卡）简单制作一个小皮影，剪裁注意安全。</li>
          <li>在「进入游戏」中学习动作与节奏；返回后完成一次 30～90 秒的小剧场展演（可自拟主题）。</li>
          <li>展演时注意肢体节奏与画面构图；结束后在本页点击「提交成绩」，老师可在飞书查看统计。</li>
        </ol>
      </section>

      <div class="hr"></div>
      <div class="foot note">© 云南师范大学附属小学 · 樱花语校区</div>
    </div>
  </div>

  <script>
    // ====== 配置 ======
    const BACKEND = "https://piying-feishu-backend.vercel.app/api/collect"; // 你的后端 Collect API
    // ====== 工具 ======
    const $ = (s) => document.querySelector(s);
    const nameEl  = $("#name");
    const gradeEl = $("#grade");
    const klassEl = $("#klass");
    const movesEl = $("#moves");
    const vseenEl = $("#vseen");
    const clockEl = $("#clock");
    const secEl   = $("#sec");
    const tipEl   = $("#tip");

    // 解析 URL 参数自动填充
    (function autofill(){
      const p = new URLSearchParams(location.search);
      if (p.get("name"))  nameEl.value  = decodeURIComponent(p.get("name"));
      if (p.get("grade")) gradeEl.value = decodeURIComponent(p.get("grade"));
      if (p.get("class")) klassEl.value = decodeURIComponent(p.get("class"));
      if (p.get("vseen")) vseenEl.value = decodeURIComponent(p.get("vseen")) === "true" ? "是"
                          : decodeURIComponent(p.get("vseen")) === "false" ? "否"
                          : decodeURIComponent(p.get("vseen"));
      if (p.get("autostart") === "1") start();
    })();

    // 草稿本地存储，防丢
    const KEY = "piying_form_draft_v1";
    (function loadDraft(){
      try{
        const d = JSON.parse(localStorage.getItem(KEY)||"{}");
        if(d.name)  nameEl.value = d.name;
        if(d.grade) gradeEl.value = d.grade;
        if(d.klass) klassEl.value = d.klass;
        if(d.moves!=null) movesEl.value = d.moves;
        if(d.vseen) vseenEl.value = d.vseen;
      }catch{}
    })();
    function saveDraft(){
      const d = {
        name: nameEl.value.trim(),
        grade: gradeEl.value,
        klass: klassEl.value.trim(),
        moves: movesEl.value ? Number(movesEl.value) : "",
        vseen: vseenEl.value
      };
      localStorage.setItem(KEY, JSON.stringify(d));
    }
    [nameEl,gradeEl,klassEl,movesEl,vseenEl].forEach(el=>el.addEventListener("change",saveDraft));

    // 计时器
    let timer=null, seconds=0;
    function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;}
    function paint(){ clockEl.textContent = fmt(seconds); secEl.textContent = `${seconds} 秒`; }
    function start(){ if(timer) return; timer=setInterval(()=>{ seconds++; paint(); },1000); tip("计时中…","warn"); }
    function pause(){ if(timer){ clearInterval(timer); timer=null; tip("已暂停","muted"); } }
    function reset(){ pause(); seconds=0; paint(); tip("计时已归零","muted"); }

    $("#btnStart").onclick = start;
    $("#btnPause").onclick = pause;
    $("#btnReset").onclick = reset;

    // 提交
