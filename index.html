
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>腾冲皮影戏 · 非遗探秘闯关</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--ok:#34d399}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei";background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
h1,h2{margin:0 0 12px}
.muted{color:var(--muted);font-size:14px}
input,select,button{border-radius:12px;border:1px solid #1f2937;padding:10px 12px;background:#0b1220;color:#fff}
button{background:var(--brand);color:#09111f;font-weight:700;cursor:pointer;border:none}
button.ghost{background:#0b1220;color:#fff;border:1px solid #374151}
button:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:12px;background:#0b1220;border:1px solid #374151;padding:2px 10px;border-radius:999px;color:#cbd5e1}
.board{--cols:4;display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:10px}
.cardtile{height:90px;background:#0b1220;border:1px solid #374151;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700}
.cardtile.open{background:linear-gradient(135deg,#0b1220,#0f172a)}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>腾冲皮影戏 · 非遗探秘闯关</h1>
    <p class="muted">四关闯关游戏，完成后将数据匿名上报云端（飞书）。</p>
    <div class="progress">
      <label>昵称 <input id="name" placeholder="如：六（3）-29"></label>
      <label>年级 <select id="grade"><option value="">请选择</option><option>一年级</option><option>二年级</option><option>三年级</option><option>四年级</option><option>五年级</option><option>六年级</option></select></label>
      <label>班级 <input id="klass" placeholder="如：六（3）班"></label>
      <label>同意匿名数据 <select id="consent"><option>是</option><option>否</option></select></label>
      <button id="start">开始</button>
    </div>
  </div>

  <div class="card" id="panel-l1" style="display:none">
    <h2>第一关 · 制作步骤</h2>
    <p class="muted">将工艺流程按顺序拼接。</p>
    <button id="to-l2" disabled>进入第二关 ➜</button>
  </div>

  <div class="card" id="panel-l2" style="display:none">
    <h2>第二关 · 知识词条</h2>
    <p class="muted">点击学习词条。</p>
    <button id="to-l3" disabled>进入第三关 ➜</button>
  </div>

  <div class="card" id="panel-l3" style="display:none">
    <h2>第三关 · 记忆配对</h2>
    <p class="muted">配对 12 张卡片。</p>
    <div><span class="badge">步数：<span id="moves3">0</span></span></div>
    <div class="board" id="board3"></div>
    <button id="to-l4" disabled>进入第四关 ➜</button>
  </div>

  <div class="card" id="panel-l4" style="display:none">
    <h2>第四关 · 奖励视频</h2>
    <video id="rewardVideo" controls width="100%">
      <source src="piying_reward.mp4" type="video/mp4"/>
    </video>
    <button id="finalize" disabled>完成并上报 ➜</button>
  </div>

</div>

<script>
const CLOUD_ENDPOINT = "https://piying-feishu-backend.vercel.app/api/collect";
let v_seen=false, moves=0;

// 切换面板
function showPanel(id){
  ["panel-l1","panel-l2","panel-l3","panel-l4"].forEach(pid=>document.getElementById(pid).style.display=(pid===id?"block":"none"));
}

document.getElementById("start").onclick=()=>{
  if(document.getElementById("grade").value===""||document.getElementById("consent").value!=="是"){
    alert("请填写完整信息并同意匿名数据采集");
    return;
  }
  showPanel("panel-l1");
};

document.getElementById("to-l2").onclick=()=>{ showPanel("panel-l2"); };
document.getElementById("to-l3").onclick=()=>{ showPanel("panel-l3"); };
document.getElementById("to-l4").onclick=()=>{ showPanel("panel-l4"); };

document.getElementById("rewardVideo").onended=()=>{
  v_seen=true;
  document.getElementById("finalize").disabled=false;
};

document.getElementById("finalize").onclick=async ()=>{
  const rec={
    user: document.getElementById("name").value,
    grade: document.getElementById("grade").value,
    clazz: document.getElementById("klass").value,
    score: moves, // 用第三关的步数
    watched: v_seen
  };
  try{
    const res=await fetch(CLOUD_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(rec)});
    const data=await res.json();
    alert("✅ 数据已提交: "+JSON.stringify(data));
  }catch(err){
    alert("❌ 提交失败: "+err);
  }
};
</script>
</body>
</html>
