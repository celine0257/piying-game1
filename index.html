<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>腾冲皮影戏 · 非遗探秘闯关</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--brand:#60a5fa;--ok:#34d399}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"PingFang SC","Microsoft YaHei";background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
h1,h2{margin:0 0 12px}
.muted{color:var(--muted);font-size:14px}
input,select,button{border-radius:12px;border:1px solid #1f2937;padding:10px 12px;background:#0b1220;color:#fff}
button{background:var(--brand);color:#09111f;font-weight:700;cursor:pointer;border:none}
button.ghost{background:#0b1220;color:#fff;border:1px solid #374151}
button:disabled{opacity:.5;cursor:not-allowed}
.badge{font-size:12px;background:#0b1220;border:1px solid #374151;padding:2px 10px;border-radius:999px;color:#cbd5e1}
.progress{display:flex;gap:4px;align-items:center;flex-wrap:wrap}
.dot{width:10px;height:10px;border-radius:50%;background:#1f2937}
.dot.on{background:linear-gradient(180deg,#a7f3d0,#10b981)}
.dot.cloud{width:8px;height:8px;margin-left:6px}
.dot.ok{background:linear-gradient(180deg,#bbf7d0,#22c55e)}
.dot.fail{background:linear-gradient(180deg,#fecaca,#ef4444)}
.gallery{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.gallery img{width:100%;height:240px;object-fit:cover;border-radius:12px;border:1px solid #374151}
.gallery .span2{grid-column:1/span 2;height:280px}
.cap{font-size:12px;color:#cbd5e1;margin:6px 2px 0}
.timeline{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px}
.stepSlot{min-height:72px;display:flex;align-items:center;justify-content:center;border:2px dashed #374151;border-radius:12px;color:#94a3b8;background:#0b1220}
.stepSlot.locked{opacity:.6;filter:grayscale(30%)}
.stepSlot.active{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3) inset}
.part{user-select:none;margin:8px 0;padding:10px 12px;background:#0f172a;border:1px solid #1f2937;border-radius:12px;cursor:grab}
.partsBox{background:#0b1220;border:1px solid #374151;border-radius:16px;padding:12px}
.good{outline:2px solid var(--ok)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.info{background:#0b1220;border:1px solid #374151;border-radius:14px;padding:12px;cursor:pointer}
.info .title{font-weight:700;margin-bottom:6px}
.info .content{display:none;font-size:13px;color:#cbd5e1}
.info.learned{outline:2px solid var(--ok)}
.board{--cols:4;display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:10px}
.cardtile{height:90px;background:#0b1220;border:1px solid #374151;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700}
.cardtile.open{background:linear-gradient(135deg,#0b1220,#0f172a)}
.videoWrap{background:#0b1220;border:1px solid #374151;border-radius:16px;padding:12px}
video{width:100%;border-radius:12px;background:#000}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
th,td{border-bottom:1px solid #223;padding:8px;text-align:left}
.footer{font-size:12px;color:#9ca3af;text-align:center;margin-top:8px}
@keyframes shakeX{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-6px)}40%,60%{transform:translateX(6px)}}
.shake{animation:shakeX .35s ease}
@media (max-width:900px){.board{--cols:3}}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>腾冲皮影戏 · 非遗探秘闯关</h1>
    <p class="muted">①制作步骤 → ②词条学习 → ③记忆配对 → ④奖励视频。通关后自动上报云端（飞书）。</p>
    <div class="progress">
      <label>昵称 <input id="name" placeholder="如：六（3）-29"></label>
      <label>年级 <select id="grade"><option value="">请选择</option><option>一年级</option><option>二年级</option><option>三年级</option><option>四年级</option><option>五年级</option><option>六年级</option></select></label>
      <label>班级 <input id="klass" placeholder="如：六（3）班"></label>
      <label>同意匿名数据 <select id="consent"><option>是</option><option>否</option></select></label>
      <span class="badge">用时：<span id="time">0</span>s</span>
      <span class="badge">进度</span><span class="dot" id="d1"></span><span class="dot" id="d2"></span><span class="dot" id="d3"></span><span class="dot" id="d4"></span>
      <span class="badge">云端 <span class="dot cloud" id="cloudDot"></span></span>
      <button id="start">开始</button>
      <button id="reset" class="ghost" disabled>重来</button>
    </div>
  </div>

  <div class="card" id="panel-intro">
    <h2>开场展板</h2>
    <div class="gallery">
      <div class="span2"><img src="校徽.png" alt=""><div class="cap">云南师大附小：非遗进校园，皮影戏“看得见、玩得起、说得出”。</div></div>
      <div><img src="皮影_树下对坐.jpg" alt=""><div class="cap">影窗（白幕）+背后灯光，演员在幕后操杆。</div></div>
      <div><img src="皮影_学生自制.jpg" alt=""><div class="cap">靠子可用卡纸/PP片理解结构与连接方法。</div></div>
      <div><img src="皮影_学生表演.jpg" alt=""><div class="cap">细竹杆联动关节；锣鼓唢呐配合节奏。</div></div>
    </div>
  </div>

  <div class="card" id="panel-l1" style="display:none">
    <h2>第一关 · 制作步骤</h2>
    <div class="timeline" id="slots">
      <div class="stepSlot" data-index="0">第1步</div>
      <div class="stepSlot locked" data-index="1">第2步</div>
      <div class="stepSlot locked" data-index="2">第3步</div>
      <div class="stepSlot locked" data-index="3">第4步</div>
      <div class="stepSlot locked" data-index="4">第5步</div>
      <div class="stepSlot locked" data-index="5">第6步</div>
    </div>
    <div class="partsBox" id="parts"></div>
    <div style="margin-top:8px"><button id="to-l2" class="ghost" disabled>进入第二关 ➜</button></div>
  </div>

  <div class="card" id="panel-l2" style="display:none">
    <h2>第二关 · 知识词条</h2>
    <div class="grid" id="infogrid"></div>
    <div style="margin-top:8px"><button id="to-l3" class="ghost" disabled>进入第三关 ➜</button></div>
  </div>

  <div class="card" id="panel-l3" style="display:none">
    <h2>第三关 · 记忆配对</h2>
    <div><span class="badge">步数：<span id="moves3">0</span></span></div>
    <div class="board" id="board3"></div>
    <div style="margin-top:8px"><button id="to-l4" disabled>去看奖励视频 ➜</button></div>
  </div>

  <div class="card" id="panel-l4" style="display:none">
    <h2>第四关 · 奖励视频</h2>
    <div class="videoWrap">
      <video id="rewardVideo" controls preload="metadata" poster="皮影_学生表演.jpg">
        <source src="piying_reward.mp4" type="video/mp4"/>
      </video>
    </div>
    <div style="margin-top:10px"><button id="finalize" class="ghost" disabled>完成并提交</button></div>
  </div>

  <div class="card">
    <h2>排行榜（本机）</h2>
    <table id="boardT"><thead><tr><th>#</th><th>昵称</th><th>年级</th><th>班级</th><th>步数</th><th>看视频</th><th>时间</th></tr></thead><tbody></tbody></table>
  </div>

</div>

<script>
const CLOUD_ENDPOINT="https://piying-feishu-backend.vercel.app/api/collect";
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
let timer=null,timeSec=0,v_seen=false;
const FLOW=["干牛皮","雕刻","涂色","连接件","安装操杆","兵器/配件"];
const FACTS={"影窗":"白幕载体","东腔":"地方唱腔","西腔":"另一唱腔","锣鼓":"配合节奏","唢呐":"高亢嘹亮","靠子":"皮影人物","操杆":"动作控制","傣族舞台":"多民族风情","故事题材":"三国西游","旅游演出":"面向游客"};

function setDot(n){[$("#d1"),$("#d2"),$("#d3"),$("#d4")].forEach((d,i)=>d.classList.toggle("on",i<n))}
function showPanel(id){["panel-intro","panel-l1","panel-l2","panel-l3","panel-l4"].forEach(pid=>$("#"+pid).style.display=(pid===id?"block":"none"))}

/*** 第一关 ***/
let current=0;
function initL1(){
  current=0;const box=$("#parts");box.innerHTML="";
  $$("#slots .stepSlot").forEach((slot,i)=>{slot.textContent=`第${i+1}步`;slot.className="stepSlot"+(i===0?" active":(i>0?" locked":""));slot.ondragover=e=>e.preventDefault();slot.ondrop=e=>{
    e.preventDefault();const name=e.dataTransfer.getData("text/plain");const idx=+slot.dataset.index;
    if(idx===current&&name===FLOW[current]){slot.classList.add("good");slot.textContent=`第${idx+1}步：${name}`;const next=$(`#slots .stepSlot[data-index="${idx+1}"]`);if(next){next.classList.remove("locked");next.classList.add("active")}const card=[...box.children].find(x=>x.dataset.name===name);card&&card.remove();current++;if(current===FLOW.length)$("#to-l2").disabled=false}else{slot.classList.add("shake");setTimeout(()=>slot.classList.remove("shake"),350)}};
  });
  FLOW.sort(()=>Math.random()-0.5).forEach(s=>{const el=document.createElement("div");el.className="part";el.textContent=`步骤：${s}`;el.draggable=true;el.dataset.name=s;el.ondragstart=e=>e.dataTransfer.setData("text/plain",s);box.appendChild(el)});
}

/*** 第二关 ***/
let learned={};
function initL2(){learned={};const grid=$("#infogrid");grid.innerHTML="";Object.keys(FACTS).forEach(k=>{const div=document.createElement("div");div.className="info";div.innerHTML=`<div class="title">${k}</div><div class="content">${FACTS[k]}</div>`;div.onclick=()=>{div.classList.add("learned");div.querySelector(".content").style.display="block";learned[k]=true;$("#to-l3").disabled=Object.keys(learned).length!==Object.keys(FACTS).length};grid.appendChild(div)})}

/*** 第三关 ***/
let deck=[],flipped=[],lock=false,matched=0,moves=0;
function initL3(){deck=[];flipped=[];lock=false;matched=0;moves=0;$("#moves3").textContent="0";$("#to-l4").disabled=true;const keys=Object.keys(FACTS).sort(()=>Math.random()-0.5).slice(0,6);deck=keys.concat(keys).sort(()=>Math.random()-0.5).map((k,i)=>({id:"c"+i,term:k}));const b=$("#board3");b.innerHTML="";deck.forEach(c=>{const t=document.createElement("div");t.className="cardtile";t.dataset.term=c.term;t.textContent="翻开";t.onclick=()=>flip(t);b.appendChild(t)})}
function flip(t){if(lock||t.classList.contains("open"))return;t.classList.add("open");t.textContent=t.dataset.term;flipped.push(t);$("#moves3").textContent=++moves;if(flipped.length===2){const[a,b]=flipped;if(a.dataset.term===b.dataset.term){flipped=[];matched++;if(matched===6)$("#to-l4").disabled=false}else{lock=true;setTimeout(()=>{a.classList.remove("open");b.classList.remove("open");a.textContent="翻开";b.textContent="翻开";flipped=[];lock=false},600)}}}

/*** 第四关 ***/
function initL4(){v_seen=false;const v=$("#rewardVideo"),btn=$("#finalize");btn.disabled=true;v.onplay=()=>{v_seen=true};v.onended=()=>{btn.disabled=false};}

$("#start").onclick=()=>{if($("#grade").value===""||$("#consent").value!=="是"){alert("请填写年级并同意匿名数据");return}setDot(0);showPanel("panel-l1");initL1()}
$("#to-l2").onclick=()=>{setDot(1);showPanel("panel-l2");initL2()}
$("#to-l3").onclick=()=>{setDot(2);showPanel("panel-l3");initL3()}
$("#to-l4").onclick=()=>{setDot(3);showPanel("panel-l4");initL4()}

/*** 提交结果 ***/
$("#finalize").onclick=async()=>{const rec={user:$("#name").value,grade:$("#grade").value,clazz:$("#klass").value,score:+$("#moves3").textContent,watched:v_seen};try{const r=await fetch(CLOUD_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(rec)});const d=await r.json();console.log("提交成功:",d);alert("✅ 已提交到飞书")}catch(e){console.error("提交失败:",e);alert("❌ 提交失败")}}
</script>
</body>
</html>
